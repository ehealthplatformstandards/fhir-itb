<testcase id="post-AllergyIntolerance" xmlns="http://www.gitb.com/tdl/v1/"
          xmlns:gitb="http://www.gitb.com/core/v1/"
>
    <metadata>
        <gitb:name>Test case 1: Submit allergy intolerances</gitb:name>
        <gitb:version>1.0</gitb:version>
        <gitb:description>The FHIR client submits a specific allergy
            intolerance to a FHIR server.
        </gitb:description>
        <!-- See here how we refer to a HTML block that will be added as documentation for the test case. -->
        <!--        <gitb:documentation import="docs/client/test-case-1.html"/>-->
    </metadata>
    <actors>
        <!--
            The Actor IDs need to match those in the test suite and in the test engine. One of these needs to always be the SUT (System Under Test).
        -->
        <gitb:actor id="client" role="SUT"/>
        <gitb:actor id="server"/>
    </actors>
    <variables>
        <!--
            The ProxyHandler will forward the request to the test cases.
        -->
        <var name="request" type="map"/>
    </variables>
    <!--
        Setting "stopOnError" to true will stop the test session as soon as an error is encountered. By default, test sessions will continue regardless of errors.
    -->
    <steps stopOnError="false">
        <log>'Started session '||$SESSION{sessionId}||' for test case
            '||$SESSION{testCaseId}||''
        </log>
        <!-- Log the received request parameters -->
        <log>"### Proxy Request Data ###"</log>
        <log>$request</log>
        <log>
            "Request URI: " || $request{uri}
        </log>
        <log>
            "Request Method: " || $request{method}
        </log>
        <log>
            "Request Headers: " || $request{headers}
        </log>
        <log>
            "Request Body: " || $request{body}
        </log>

        <!-- Extract patient ID from the JSON request body -->
        <process handler="JSONPointerProcessor" output="patientID">
            <input name="content">$request{body}</input>
            <input name="pointer">"/patient/identifier/value"</input>
        </process>

        <!-- validate the patientID -->
        <verify handler="StringValidator">
            <input name="actualstring">$patientID</input>
            <input name="expectedstring">"1234567890"</input>
        </verify>

        <!-- Use handler="$DOMAIN{messagingServiceAddress}" to trigger the Proxied request and get the response. -->
        <send id="proxyResponse" handler="$DOMAIN{messagingServiceAddress}" from="client" to="server"/>
        <log>"### Proxy Response Data ###"</log>
        <log>$proxyResponse{response}</log>
        <log>
            "Proxy Response status: " || $proxyResponse{response}{status}
        </log>
        <log>
            "Proxy Response headers: " || $proxyResponse{response}{headers}
        </log>
        <log>
            "Proxy Response body: " || $proxyResponse{response}{body}
        </log>

        <!-- Validate Status Code -->
        <verify handler="StringValidator">
            <input name="actualstring">$proxyResponse{response}{status}</input>
            <input name="expectedstring">"201 CREATED"</input>
        </verify>

        <!-- Use the HttpMessagingV2 handler to send ordinary HTTP requests. -->
        <send id="httpSend" from="client" to="server" handler="HttpMessagingV2">
            <input name="uri">
                "https://webhook.site/b8f30bd9-c04d-4f9c-83da-29924080fd95/test"
            </input>
            <input name="method">"POST"</input>
        </send>
        <log>"### HttpMessagingV2 ###"</log>
        <log>$httpSend{response}</log>
    </steps>
    <!-- The output section allows us to define specialised summary error (or success) messages to make the result more user-friendly. -->
    <output>
        <success>
            <default>"Test case passed successfully."</default>
        </success>
        <failure>
            <default>"Test case failed."</default>
        </failure>
    </output>
</testcase>
